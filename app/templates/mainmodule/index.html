<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бар Онлайн Заказ</title>
    <link type="text/css" href="{{ url_for('static', filename='css/styles.css')}}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/scripts.js')}}"></script>
</head>
<body>
    <div id="main-wrapper">
        <header class="header">
            <span class="open-btn" onclick="openNav()">&#9776; Меню</span>
            <h1 class="bar-title">Дом печати</h1>
            <a href="{{url_for('mainmodule.order')}}" class="bar-title">Корзина</a>
        </header>

        <div class="sidebar" id="sidebar">
            <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>
            {% for category in categories %}
                {% if category.subcategory == None %}
                <a href="{{url_for('mainmodule.products', category_id=category.id)}}">
                    {{ category.name }}
                </a>
                {% endif %}
            {% endfor %}
        </div>

        <main>
            <section class="menu">
                <form action="{{ url_for('mainmodule.add_to_order') }}" method="POST" id="order-form">
                    <ul>
                        {% for subcategories, products in products_by_subcategories.items() %}
                            <h2>{{ subcategories }}</h2>
                            <br>
                            {% for product in products %}
                                <li class="menu-item">
                                    <div class="item-info">
                                        <h3>{{ product.name }} - {{ product.price }} ₽</h3>
                                        <p>
                                            {% for ingredient in product.ingredients %}
                                                {% if ingredient != None %}
                                                    {% if loop.first %}
                                                        {{ ingredient.capitalize() }},
                                                    {% elif loop.last %}
                                                        {{ ingredient.lower() }}
                                                    {% else %}
                                                        {{ ingredient.lower() }},
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </p>
                                    </div>
                                    <div class="quantity-controls">
                                        <button class="add-button" type="button" onclick="changeQuantity('item{{ product.id }}', -1)">-</button>
                                        <input class="count-item" type="text" id="item{{ product.id }}" name="{{ product.name }}" value="0" min="0">
                                        <button class="add-button" type="button" onclick="changeQuantity('item{{ product.id }}', 1)">+</button>
                                    </div>
                                </li>
                            {% endfor %}
                            <br>
                        {% endfor %}
                    </ul>
                    <input type="hidden" name="category_id" value="{{ category_id }}">
                    <button class="order-button" type="submit">Добавить в заказ</button>
                </form>
            </section>
        </main>

        <footer>
            <p>Свяжитесь с нами: +7 123 456 7890</p>
        </footer>
    </div>

    <script>
        document.getElementById('order-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const categoryId = formData.get('category_id');
            const products = [];

            // Перебираем все продукты и собираем их id и количество
            formData.forEach((quantity, productName) => {
                if (productName !== 'category_id' && quantity > 0) {
                    products.push({
                        id: productName, // Используем название как id (можно заменить на реальные ids)
                        quantity: parseInt(quantity)
                    });
                }
            });

            // Создаём JSON объект
            const data = {
                category_id: categoryId,
                products: products
            };

            // Отправляем данные на сервер через fetch
            fetch('/add_to_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    window.location.href = `/products/category/${categoryId}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        //Меню навигации
        function openNav() {
            document.getElementById("sidebar").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("sidebar").style.width = "0";
        }

        //Изменение кол-ва продуктов в поле 
        function changeQuantity(itemId, change) {
            const item = document.getElementById(itemId);
            let quantity = parseInt(item.value);
            if (!isNaN(quantity) && quantity + change >= 0) {
                item.value = quantity + change;
            }
        }
    </script>
</body>
</html>
